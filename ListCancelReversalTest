package net.jpmchase.smb.ach.component.steps;

import com.github.tomakehurst.wiremock.WireMockServer;
import com.github.tomakehurst.wiremock.core.WireMockConfiguration;
import io.cucumber.java.After;
import io.cucumber.java.Before;
import io.cucumber.java.en.Given;
import io.cucumber.java.en.Then;
import io.cucumber.java.en.When;
import net.jpmchase.smb.ach.model.ACHPaymentListCancelReversalRequest;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.test.util.TestSocketUtils;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.util.UriComponentsBuilder;
import java.io.IOException;
import java.net.URI;
import static com.github.tomakehurst.wiremock.client.WireMock.*;
import static org.junit.jupiter.api.Assertions.assertEquals;
import static com.github.tomakehurst.wiremock.client.WireMock.aResponse;

public class ListCancelReversalTest {

    private ACHPaymentListCancelReversalRequest achPaymentListCancelReversalRequest;

    private ResponseEntity<ACHPaymentListCancelReversalRequest> responseObject;

    private URI baseUri;

    private RestTemplate restTemplate;

    private WireMockServer wireMockServer;

    private final int port = TestSocketUtils.findAvailableTcpPort();

    @Before
    public void beforeScenario() {

        wireMockServer = new WireMockServer(WireMockConfiguration.options().port(port));
        wireMockServer.start();
        baseUri = UriComponentsBuilder.newInstance().scheme("http").host("localhost")
                .port("8082").path("/ccb/smb/ach/payments/reversal/v1/reversal-requests-details").build().toUri();
    }


    @Given(": A list cancel reversal request is submitted")
    public void aPaymentReversalRequestIsSubmitted() {
        achPaymentListCancelReversalRequest = new ACHPaymentListCancelReversalRequest();
        achPaymentListCancelReversalRequest.setPaymentId(46464L);
    }

    @When(": I call the list cancel reversal API")
    public void iCallTheSubmitReversalAPI() throws IOException {


        String responseBodyString = "{\"payeeAccountNickname\":\"dhruv\",\"accountNumber\":\"464645\",\"paymentId\":66464,\"amount\":4646,\"lastUpdatedDate\":\"2024-07-01 11:10:24\",\"reversalReason\":{\"reversalReasonCode\":50645,\"reversalReasonDesc\":\"Duplicate Payment\"},\"reversalRequestedDate\":\"2024-07-01 11:10:24\",\"issue\":null}";

        configureFor("localhost", port);
        stubFor(post(urlEqualTo("/ccb/payments/payment-instructions/v1/list/cancel/reversal"))
                .withHeader("Content-Type", equalTo("application/json"))
                .willReturn(aResponse().withStatus(200).withBody(responseBodyString).withHeader("Content-Type", "application/json")));

        HttpHeaders httpHeaders = new HttpHeaders();
        httpHeaders.setContentType(MediaType.APPLICATION_JSON);
        httpHeaders.add("online-profile-identifier", "345654");
        httpHeaders.add("segmentId", "CML");

        org.springframework.http.HttpEntity<ACHPaymentListCancelReversalRequest> reqEntity = new HttpEntity<>(achPaymentListCancelReversalRequest, httpHeaders);

        restTemplate = new RestTemplate();
        responseObject = restTemplate.postForEntity(baseUri, reqEntity, ACHPaymentListCancelReversalRequest.class);
    }

    @Then(": I Should receive a success response of {int} for list cancel reversal call")
    public void iShouldReceiveASuccessResponseOf(int statusCode) {
        assertEquals(responseObject.getStatusCode().value(), statusCode);
    }

    @After
    public void wiremockServerIsStopped() {
        wireMockServer.stop();
        System.out.println("Stopped the wire mock server.");
    }
}
M
10:38â€¯PM
package net.jpmchase.smb.ach.component.steps;

import com.github.tomakehurst.wiremock.WireMockServer;
import com.github.tomakehurst.wiremock.core.WireMockConfiguration;
import io.cucumber.java.After;
import io.cucumber.java.Before;
import io.cucumber.java.en.Given;
import io.cucumber.java.en.Then;
import io.cucumber.java.en.When;
import lombok.extern.slf4j.Slf4j;
import net.jpmchase.smb.ach.model.ACHPaymentListReversalRequest;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.test.util.TestSocketUtils;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.util.UriComponentsBuilder;
import java.io.IOException;
import java.net.URI;
import static com.github.tomakehurst.wiremock.client.WireMock.*;
import static org.junit.jupiter.api.Assertions.assertEquals;
import static com.github.tomakehurst.wiremock.client.WireMock.aResponse;

@Slf4j
public class ListReversalTest {

    private ACHPaymentListReversalRequest achPaymentListReversalRequest;

    private ResponseEntity<ACHPaymentListReversalRequest> responseObject;

    private URI baseUri;

    private RestTemplate restTemplate;

    private WireMockServer wireMockServer;

    private final int port = TestSocketUtils.findAvailableTcpPort();

    @Before
    public void beforeScenario() {

        wireMockServer = new WireMockServer(WireMockConfiguration.options().port(port));
        wireMockServer.start();
        baseUri = UriComponentsBuilder.newInstance().scheme("http").host("localhost")
                .port("8082").path("/ccb/smb/ach/payments/reversal/v1/reversal-requests-details").build().toUri();
    }

    @Given(": A payment list reversal request is submitted")
    public void aPaymentReversalRequestIsSubmitted() {

        achPaymentListReversalRequest = new ACHPaymentListReversalRequest();
        achPaymentListReversalRequest.setPaymentId(66464L);
    }

    @When(": I call the list reversal API")
    public void iCallTheListReversalAPI() throws IOException {


        String responseBodyString = "{\"payeeAccountNickname\":\"dhruv\",\"accountNumber\":\"464645\",\"paymentId\":66464,\"amount\":4646,\"lastUpdatedDate\":\"2024-07-01 11:10:24\",\"reversalReason\":{\"reversalReasonCode\":50645,\"reversalReasonDesc\":\"Duplicate Payment\"},\"issue\":null}";

        configureFor("localhost", port);
        stubFor(post(urlEqualTo("/ccb/payments/payment-instructions/v1/list/reversal")).withHeader("Content-Type", equalTo("application/json"))
                .willReturn(aResponse().withStatus(200).withHeader("Content-Type", "application/json").withBody(responseBodyString)));

        HttpHeaders httpHeaders = new HttpHeaders();
        httpHeaders.setContentType(MediaType.APPLICATION_JSON);
        httpHeaders.add("online-profile-identifier", "345654");
        httpHeaders.add("segmentId", "CML");

        org.springframework.http.HttpEntity<ACHPaymentListReversalRequest> reqEntity = new HttpEntity<>(achPaymentListReversalRequest, httpHeaders);

        restTemplate = new RestTemplate();
        responseObject = restTemplate.postForEntity(baseUri, reqEntity, ACHPaymentListReversalRequest.class);
    }

    @Then(": I Should receive a success response of {int} for list reversal call")
    public void iShouldReceiveASuccessResponseOf(int statusCode) {
        assertEquals(responseObject.getStatusCode().value(), statusCode);
    }

    @After
    public void wiremockServerIsStopped() {
        wireMockServer.stop();
        System.out.println("Stopped the wire mock server.");
    }
}
package net.jpmchase.smb.ach.component.steps;

import com.github.tomakehurst.wiremock.WireMockServer;
import com.github.tomakehurst.wiremock.core.WireMockConfiguration;
import io.cucumber.java.After;
import io.cucumber.java.Before;
import io.cucumber.java.en.Given;
import io.cucumber.java.en.Then;
import io.cucumber.java.en.When;
import net.jpmchase.smb.ach.model.ACHPaymentCancelReversalRequest;
import org.springframework.http.*;
import org.springframework.test.util.TestSocketUtils;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.util.UriComponentsBuilder;
import java.io.IOException;
import java.net.URI;
import static com.github.tomakehurst.wiremock.client.WireMock.*;
import static org.junit.jupiter.api.Assertions.assertEquals;

public class SubmitCancelReversalTest {

    private ACHPaymentCancelReversalRequest achPaymentCancelReversalRequest;

    private ResponseEntity<ACHPaymentCancelReversalRequest> responseObject;

    private URI baseUri;

    private RestTemplate restTemplate;

    private WireMockServer wireMockServer;

    private final int port = TestSocketUtils.findAvailableTcpPort();

    @Before
    public void beforeScenario() {

        wireMockServer = new WireMockServer(WireMockConfiguration.options().port(port));
        wireMockServer.start();
        baseUri = UriComponentsBuilder.newInstance().scheme("http").host("localhost")
                .port("8082").path("/ccb/smb/ach/payments/reversals/v1/reversal-cancellations").build().toUri();
    }


    @Given(": A Submit cancel reversal request is submitted")
    public void aPaymentReversalRequestIsSubmitted() {
        achPaymentCancelReversalRequest = new ACHPaymentCancelReversalRequest();
        achPaymentCancelReversalRequest.setPaymentId(46464L);
        achPaymentCancelReversalRequest.setReversalReasonName("Duplicate Payment");
    }

    @When(": I call the Submit cancel reversal API")
    public void iCallTheSubmitReversalAPI() throws IOException {


        String responseBodyString = "{\"issue\":null}";

        configureFor("localhost", port);
        stubFor(post(urlEqualTo("/ccb/payments/payment-instructions/v1/cancel/reversal"))
                .withHeader("Content-Type", equalTo("application/json"))
                .willReturn(aResponse().withStatus(200).withBody(responseBodyString).withHeader("Content-Type", "application/json")));

        HttpHeaders httpHeaders = new HttpHeaders();
        httpHeaders.setContentType(MediaType.APPLICATION_JSON);
        httpHeaders.add("online-profile-identifier", "345654");
        httpHeaders.add("authorization", "authorization");
        httpHeaders.add("trace-id","45469549");
        httpHeaders.add("channel-type","C30");

        HttpEntity<ACHPaymentCancelReversalRequest> reqEntity = new HttpEntity<>(achPaymentCancelReversalRequest, httpHeaders);

        restTemplate = new RestTemplate();
        responseObject = restTemplate.postForEntity(baseUri, reqEntity, ACHPaymentCancelReversalRequest.class);
    }

    @Then(": I Should receive a success response of {int} for Submit cancel reversal call")
    public void iShouldReceiveASuccessResponseOf(int statusCode) {
        assertEquals(responseObject.getStatusCode().value(), statusCode);
    }

    @After
    public void wiremockServerIsStopped() {
        wireMockServer.stop();
        System.out.println("Stopped the wire mock server.");
    }
}
package net.jpmchase.smb.ach.component.steps;

import com.github.tomakehurst.wiremock.WireMockServer;
import com.github.tomakehurst.wiremock.core.WireMockConfiguration;
import io.cucumber.java.After;
import io.cucumber.java.Before;
import io.cucumber.java.en.Given;
import io.cucumber.java.en.Then;
import io.cucumber.java.en.When;
import net.jpmchase.smb.ach.model.ACHPaymentReversalRequest;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.test.util.TestSocketUtils;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.util.UriComponentsBuilder;
import java.io.IOException;
import java.net.URI;
import static com.github.tomakehurst.wiremock.client.WireMock.*;
import static org.junit.jupiter.api.Assertions.assertEquals;

public class SubmitReversalTest {

    private ACHPaymentReversalRequest achPaymentReversalRequest;

    private ResponseEntity<ACHPaymentReversalRequest> responseObject;

    private URI baseUri;

    private RestTemplate restTemplate;

    private WireMockServer wireMockServer;

    private final int port = TestSocketUtils.findAvailableTcpPort();

    @Before
    public void beforeScenario() {

        wireMockServer = new WireMockServer(WireMockConfiguration.options().port(port));
        wireMockServer.start();
        baseUri = UriComponentsBuilder.newInstance().scheme("http").host("localhost")
                .port("8082").path("/ccb/smb/ach/payments/reversals/v1/reversal-requests").build().toUri();
    }


    @Given(": A payment reversal request is submitted")
    public void aPaymentReversalRequestIsSubmitted() {

        achPaymentReversalRequest = new ACHPaymentReversalRequest();
        achPaymentReversalRequest.setPaymentId(65156L);
        achPaymentReversalRequest.setReversalReasonName("Reversal_Duplicate_pymt");
    }

    @When(": I call the submit reversal API")
    public void iCallTheSubmitReversalAPI() throws IOException {


        String responseBodyString = "{\"BusinessException\":\"OK\"}";

        configureFor("localhost", port);
        stubFor(post(urlEqualTo("/ccb/payments/payment-instructions/v1/submit/reversal"))
                .withHeader("Content-Type", equalTo("application/json"))
                .willReturn(aResponse().withStatus(200).withBody(responseBodyString).withHeader("Content-Type", "application/json")));

        HttpHeaders httpHeaders = new HttpHeaders();
        httpHeaders.setContentType(MediaType.APPLICATION_JSON);
        httpHeaders.add("online-profile-identifier", "345654");
        httpHeaders.add("authorization", "authorization");
        httpHeaders.add("trace-id","45469549");
        httpHeaders.add("channel-type","C30");

        org.springframework.http.HttpEntity<ACHPaymentReversalRequest> reqEntity = new HttpEntity<>(achPaymentReversalRequest, httpHeaders);

        restTemplate = new RestTemplate();
        responseObject = restTemplate.postForEntity(baseUri, reqEntity, ACHPaymentReversalRequest.class);
    }

    @Then(": I Should receive a success response of {int} for submit reversal call")
    public void iShouldReceiveASuccessResponseOf(int statusCode) {
        assertEquals(responseObject.getStatusCode().value(), statusCode);
    }

    @After
    public void wiremockServerIsStopped() {
        wireMockServer.stop();
        System.out.println("Stopped the wire mock server.");
    }
}
//package net.jpmchase.smb.ach.component.runner;
//
//import io.cucumber.spring.CucumberContextConfiguration;
//import org.junit.platform.suite.api.*;
//import org.springframework.boot.test.context.SpringBootTest;
//import org.springframework.test.context.ActiveProfiles;
//import org.springframework.test.context.ContextConfiguration;
//import static io.cucumber.core.options.Constants.GLUE_PROPERTY_NAME;
//
//@Suite
//@CucumberContextConfiguration
//@ContextConfiguration
//@ActiveProfiles("comptest")
//@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.DEFINED_PORT)
//@IncludeEngines("cucumber")
//@SelectClasspathResource("features")
//@ConfigurationParameter(key = GLUE_PROPERTY_NAME, value = "net.jpmchase.smb.ach.component.runner, net.jpmchase.smb.ach.component.steps")
//@IncludeTags("component")
//public class ComponentTestRunner {
//}
package net.jpmchase.smb.ach.component.controller;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.media.Content;
import io.swagger.v3.oas.annotations.media.Schema;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import jakarta.validation.Valid;
import lombok.extern.slf4j.Slf4j;
import net.jpmchase.smb.ach.exception.BusinessException;
import net.jpmchase.smb.ach.model.*;
import net.jpmchase.smb.ach.remote.PaymentProductClient;
import net.jpmchase.smb.ach.remote.model.ACHReversalReason;
import net.jpmchase.smb.ach.service.ACHPaymentCancelReversalSvc;
import net.jpmchase.smb.ach.util.PaymentErrors;
import org.apache.commons.lang3.math.NumberUtils;
import org.jetbrains.annotations.NotNull;
import org.springframework.http.MediaType;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import java.util.List;
import java.util.stream.Collectors;

@RestController
@RequestMapping("/reversal/v1")
@Slf4j
public class ACHPaymentExperienceReversalControllerTest {

    PaymentProductClient paymentProductClient;

    ACHPaymentCancelReversalSvc achPaymentCancelReversalSvc;

    public ACHPaymentExperienceReversalControllerTest(PaymentProductClient paymentProductClient, ACHPaymentCancelReversalSvc achPaymentCancelReversalSvc) {
        this.paymentProductClient = paymentProductClient;
        this.achPaymentCancelReversalSvc = achPaymentCancelReversalSvc;
    }

    /**
     * This method is used to list the reversal transaction details
     *
     * @param achPaymentListReversalRequest
     * @return ACHPaymentListReversalResponse
     * @throws BusinessException
     */
    @Operation(summary = "Retrieve details of a given transaction for reversal")
    @ApiResponses(value = {@ApiResponse(responseCode = "200", description = "Successful operation", content = {
            @Content(mediaType = MediaType.APPLICATION_JSON_VALUE,
                    schema = @Schema(implementation = ACHPaymentListReversalResponse.class))}),
            @ApiResponse(responseCode = "401", description = "Authorization Failure"),
            @ApiResponse(responseCode = "400", description = "Request is missing a required parameter or is malformed"),
            @ApiResponse(responseCode = "404", description = "Requested resource not found"),
            @ApiResponse(responseCode = "500", description = "Internal Server Error")})
    @PostMapping(value = "/reversal-requests-details", produces = MediaType.APPLICATION_JSON_VALUE, consumes = MediaType.APPLICATION_JSON_VALUE)
    public ACHPaymentListReversalResponse listReversalRequest(@Parameter(required = true) @RequestBody @Valid final ACHPaymentListReversalRequest achPaymentListReversalRequest) throws BusinessException {

            ACHPaymentListReversalResponse achPaymentListReversalResponse = new ACHPaymentListReversalResponse();
            if (achPaymentListReversalRequest != null) {
                try{
                    net.jpmchase.smb.ach.remote.model.ACHPaymentListReversalRequest achPaymentProductListReversalRequest = getAchPaymentListReversalRequest(achPaymentListReversalRequest);
                    net.jpmchase.smb.ach.remote.model.ACHPaymentListReversalResponse achPaymentProductListReversalResponse;
                    achPaymentProductListReversalResponse = paymentProductClient.listReversalRequest(achPaymentProductListReversalRequest).getBody();
                    if(achPaymentProductListReversalResponse.getIssue()!=null && !achPaymentProductListReversalResponse.getIssue().getErrorCode().equals(0)){
                        achPaymentListReversalResponse.setErrorCode(achPaymentProductListReversalResponse.getIssue().getErrorCode());
